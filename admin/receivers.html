<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收件设置-Console</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/all.min.css" rel="stylesheet">
    <link href="files/admin.css" rel="stylesheet">
    <style>
        /* 新增 Toast 提示框样式 */
        .custom-toast {
            position: fixed;
            padding: 6px 12px;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .custom-toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>

<div id="admin-container">
    <div class="mobile-header">
        <span class="fw-bold">收件设置</span>
        <button class="btn btn-sm btn-light" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div class="admin-sidebar" id="sidebar">
        <div class="sidebar-header"><i class="far fa-mail-bulk"></i> 邮箱管理后台</div>
        <ul class="list-unstyled">
            <li><a class="nav-link" href="gmail.html"><i class="fab fa-google"></i> Gmail邮箱管理</a></li>
            <li><a class="nav-link" href="outlook.html"><i class="fab fa-microsoft"></i> 微软邮箱管理</a></li>
            <li><a class="nav-link active" href="receivers.html"><i class="fas fa-inbox"></i> 收件设置</a></li>
            <li><a class="nav-link" href="logs.html"><i class="fas fa-history"></i> 发送记录</a></li>
            <li><a class="nav-link" href="settings.html"><i class="fas fa-cog"></i> 系统设置</a></li>
            <li><a class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出登录</a></li>
        </ul>
    </div>

    <div class="admin-content">
        <div class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0">收件规则配置</h3>
                <button class="btn btn-sm btn-success" onclick="showRecvModal()"><i class="fas fa-plus"></i> 新增规则</button>
            </div>
            <div class="alert alert-info small border-0 bg-opacity-10 bg-info text-info-emphasis">
                <i class="fas fa-info-circle me-1"></i> 访问链接格式：<code>https://你的域名/查询码</code> 即可直接收取邮件。
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 25%">名称 / 绑定节点</th>
                            <th style="width: 35%">查询码 / 发送测试</th>
                            <th style="width: 15%">抓取数 / 有效期</th>
                            <th style="width: 15%">匹配规则</th>
                            <th style="width: 10%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recvTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recvModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">编辑收件规则</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <form id="recvForm">
        <input type="hidden" id="recvId">
        <div class="mb-3">
            <label class="form-label">指定 API 节点 <span class="text-danger">*</span></label>
            <input class="form-control" list="apiOptions" id="recvTargetApi" placeholder="必填，请输入或选择 API 名称" required>
            <datalist id="apiOptions"></datalist>
            <div class="form-text small">必须指定一个现有的 API 节点名称。</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">规则名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="recvName" placeholder="如: 接收验证码" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">查询码 <span class="text-danger">*</span></label>
                <div class="input-group">
                    <input type="text" class="form-control" id="recvCode" placeholder="URL 访问凭证" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="genRecvCode()">生成</button>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">单次抓取数量</label>
                <input type="number" class="form-control" id="recvCount" placeholder="留空默认: 5">
            </div>
            <div class="col-md-6">
                <label class="form-label">有效期 (天)</label>
                <input type="number" class="form-control" id="recvDays" placeholder="留空则永久有效">
            </div>
        </div>
        <hr>
        <div class="mb-3">
            <label class="form-label">发件人匹配 (可选)</label>
            <input type="text" class="form-control" id="recvSender" placeholder="留空则收取所有发件人">
        </div>
        <div class="mb-3">
            <label class="form-label">正文关键字匹配 (可选)</label>
            <input type="text" class="form-control" id="recvBody" placeholder="留空则收取所有内容">
        </div>
    </form>
</div><div class="modal-footer"><button class="btn btn-primary" onclick="submitRecv()">保存配置</button></div></div></div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="files/admin.js"></script>
<script>
    checkAuth();
    
    let recvModal;
    window.onload = function() {
        recvModal = new bootstrap.Modal(document.getElementById('recvModal'));
        loadReceivers();
    }

    // === 修改点 1：重写加载列表函数，增加邮件内容输入框和样式 ===
    async function loadReceivers() {
        const tbody = document.getElementById('recvTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">加载中...</td></tr>';
        const list = await api('/api/admin/receivers');
        if (!list) return;
        
        tbody.innerHTML = list.map(item => {
            const isInfinite = item.valid_days === 0;
            let daysDisplay = isInfinite ? '<span class="text-success small fw-bold"><i class="fas fa-infinity"></i> 永久有效</span>' : '';
            if (!isInfinite) {
                const start = new Date(item.updated_at).getTime();
                const expire = start + (item.valid_days * 86400000);
                const daysLeft = ((expire - Date.now()) / 86400000).toFixed(1);
                daysDisplay = `<span class="small ${daysLeft <= 0 ? 'text-danger fw-bold' : 'text-success'}">剩余: ${daysLeft} 天</span>`;
            }

            // 处理图标颜色和类型
            let providerIcon = '';
            if (item.provider === 'gmail') {
                providerIcon = '<i class="fab fa-google fa-lg me-2" style="color: #F57C00;" title="Google Gmail"></i>'; 
            } 
            else if (item.provider === 'outlook') {
                providerIcon = '<i class="fab fa-microsoft fa-lg me-2" style="color: #0078D4;" title="Microsoft Outlook"></i>'; 
            } 
            else {
                providerIcon = '<i class="fas fa-server fa-lg me-2 text-secondary"></i>';
            }

            return `<tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${providerIcon}
                        <div>
                            <div class="fw-bold">${item.name}</div>
                            ${item.target_api_name ? `<span class="badge bg-primary bg-opacity-75 text-white small" style="font-weight:400; font-size: 0.75rem;">${item.target_api_name}</span>` : '<span class="badge bg-secondary small">随机节点</span>'}
                        </div>
                    </div>
                </td>
                <td>
                    <div class="mb-2 d-flex align-items-center">
                        <code class="user-select-all me-2 bg-light border px-1 rounded">${item.access_code}</code>
                        <a href="/${item.access_code}" target="_blank" class="btn btn-sm btn-light border py-0 px-2" title="访问链接"><i class="fas fa-external-link-alt small"></i></a>
                    </div>
                    <div style="max-width: 280px;">
                        <input type="text" class="form-control form-control-sm mb-1" placeholder="输入邮箱发送测试..." id="send-input-${item.id}">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="内容 (留空默认发日期)" id="send-body-${item.id}">
                            <button class="btn btn-outline-secondary" type="button" onclick="sendDirect('${item.target_api_name}', ${item.id}, this, event)" title="发送">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </td>
                <td><div class="small">抓取: ${item.fetch_count} 封</div><div>${daysDisplay}</div></td>
                <td class="small text-muted"><div>发件: ${item.match_sender || '-'}</div><div>正文: ${item.match_body || '-'}</div></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editRecv(${JSON.stringify(item)})' title="编辑"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delRecv(${item.id})" title="删除"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    // === 修改点 2：新增直接发送邮件函数（支持自定义内容、默认时间和 Toast 提示） ===
    async function sendDirect(nodeName, id, btn, e) {
        // 阻止默认事件
        if(e) e.preventDefault();
        
        // 简单 Toast 提示函数
        const showToast = (msg, success) => {
            const toast = document.createElement('div');
            toast.className = 'custom-toast show';
            toast.style.backgroundColor = success ? 'rgba(25, 135, 84, 0.9)' : 'rgba(220, 53, 69, 0.9)'; // 绿/红
            toast.style.left = (e ? e.clientX : window.innerWidth/2) + 'px';
            toast.style.top = (e ? e.clientY : window.innerHeight/2) + 'px';
            toast.innerText = msg;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        };

        if (!nodeName) return showToast("未绑定有效节点，无法发送", false);
        
        const emailInput = document.getElementById(`send-input-${id}`);
        const bodyInput = document.getElementById(`send-body-${id}`);
        
        const toEmail = emailInput.value.trim();
        let bodyContent = bodyInput.value.trim();
        
        if (!toEmail) {
            emailInput.focus();
            return showToast("请输入邮箱地址", false);
        }

        // 【修改点】如果内容为空，使用指定格式的时间戳 + 时钟图标
        if (!bodyContent) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            bodyContent = `The time is: ${y}-${m}-${d} ${h}:${min}:${s} ⏰`;
        }

        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(toEmail)) {
             return showToast("请输入有效的邮箱地址", false);
        }

        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const res = await api('/api/admin/send_direct', 'POST', {
                node_name: nodeName,
                to_email: toEmail,
                body: bodyContent
            });

            if (res && res.success) {
                showToast('发送成功！', true);
            } else {
                showToast('发送失败：' + (res ? res.msg : '未知错误'), false);
            }
        } catch (error) {
            showToast('网络或系统错误', false);
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    async function loadApiOptions() {
        const listObj = document.getElementById('apiOptions');
        listObj.innerHTML = '';
        
        const gmails = await api('/api/admin/gmails');
        if (gmails) gmails.forEach(node => { 
            if(node.is_active) { 
                const opt = document.createElement('option'); 
                opt.value = node.name; 
                opt.label = `[Gmail] ${node.alias || node.name}`;
                listObj.appendChild(opt); 
            }
        });

        const outlooks = await api('/api/admin/outlooks');
        if (outlooks) outlooks.forEach(node => {
            if(node.is_active) {
                const opt = document.createElement('option');
                opt.value = node.name;
                opt.label = `[Outlook] ${node.alias || node.name}`;
                listObj.appendChild(opt);
            }
        });
    }

    async function showRecvModal() {
        document.getElementById('recvForm').reset();
        document.getElementById('recvId').value = '';
        await loadApiOptions();
        genRecvCode();
        recvModal.show();
    }

    async function editRecv(item) {
        await loadApiOptions();
        document.getElementById('recvId').value = item.id;
        document.getElementById('recvName').value = item.name;
        document.getElementById('recvTargetApi').value = item.target_api_name || ''; 
        document.getElementById('recvCode').value = item.access_code;
        document.getElementById('recvCount').value = item.fetch_count; 
        document.getElementById('recvDays').value = (item.valid_days === 0) ? '' : item.valid_days;
        document.getElementById('recvSender').value = item.match_sender || '';
        document.getElementById('recvBody').value = item.match_body || '';
        recvModal.show();
    }

    function genRecvCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 10; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('recvCode').value = result;
    }

    async function submitRecv() {
        const targetApi = document.getElementById('recvTargetApi').value.trim();
        const name = document.getElementById('recvName').value.trim();
        const code = document.getElementById('recvCode').value.trim();
        if (!targetApi || !name || !code) return alert("请完善必填项");

        const data = {
            id: document.getElementById('recvId').value,
            name: name,
            access_code: code,
            target_api_name: targetApi,
            fetch_count: document.getElementById('recvCount').value.trim() || 5,
            valid_days: document.getElementById('recvDays').value.trim() || 0,
            match_sender: document.getElementById('recvSender').value.trim(),
            match_body: document.getElementById('recvBody').value.trim()
        };
        const res = await api('/api/admin/receivers', 'POST', data);
        if(res.success) { recvModal.hide(); loadReceivers(); } else alert('保存失败: ' + res.msg);
    }

    async function delRecv(id) {
        if(confirm('确定删除此规则？链接将失效。')) {
            await api(`/api/admin/receivers/${id}`, 'DELETE');
            loadReceivers();
        }
    }
</script>
</body>
</html>
