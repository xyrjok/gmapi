<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 保持原有的 CSS */
        :root { --sidebar-width: 240px; --header-height: 60px; --primary-color: #409EFF; --sidebar-bg: #2c3e50; }
        body { background-color: #f4f7f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-container { width: 380px; padding: 40px; background: #fff; border-radius: 8px; text-align: center; }
        #admin-container { display: none; min-height: 100vh; display: flex; }
        .admin-sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); color: #ecf0f1; position: fixed; top: 0; bottom: 0; left: 0; padding-top: 20px; }
        .nav-link { color: #bdc3c7; padding: 15px 20px; cursor: pointer; display: block; text-decoration: none; }
        .nav-link:hover, .nav-link.active { background: #34495e; color: #fff; border-left: 4px solid var(--primary-color); }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        .admin-content { margin-left: var(--sidebar-width); flex: 1; padding: 20px; }
        .content-card { background: #fff; padding: 25px; border-radius: 5px; display: none; animation: fadeIn 0.3s; }
        .content-card.active { display: block; }
        @keyframes fadeIn { from { opacity: 0.5; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* 移动端 */
        @media (max-width: 768px) { .admin-sidebar { transform: translateX(-100%); transition: 0.3s; z-index: 1000; } .admin-sidebar.show { transform: translateX(0); } .admin-content { margin-left: 0; } }
    </style>
</head>
<body>

<div id="login-wrapper">
    <div class="login-container">
        <h3><i class="fas fa-mail-bulk"></i> Gmail 控制台</h3>
        <form id="login-form" class="mt-4">
            <input type="text" id="login-username" class="form-control mb-3" placeholder="用户名" required>
            <input type="password" id="login-password" class="form-control mb-3" placeholder="密码" required>
            <button type="submit" class="btn btn-primary w-100">登 录</button>
        </form>
    </div>
</div>

<div id="admin-container">
    <div class="admin-sidebar" id="sidebar">
        <div class="text-center mb-4 fw-bold">Gmail Console</div>
        <ul class="list-unstyled">
            <li><a class="nav-link active" onclick="switchTab('gmails')"><i class="fas fa-server"></i> API 节点</a></li>
            <li><a class="nav-link" onclick="switchTab('receivers')"><i class="fas fa-inbox"></i> 收件设置</a></li> <li><a class="nav-link" onclick="switchTab('logs')"><i class="fas fa-history"></i> 发送记录</a></li>
            <li><a class="nav-link" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 系统设置</a></li>
            <li><a class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出</a></li>
        </ul>
    </div>

    <div class="admin-content">
        
        <div id="tab-gmails" class="content-card active">
            <div class="d-flex justify-content-between mb-4 border-bottom pb-2">
                <h3>API 节点管理</h3>
                <button class="btn btn-sm btn-success" onclick="showAddModal()">+ 添加节点</button>
            </div>
            <table class="table table-hover"><tbody id="gmailTableBody"></tbody></table>
        </div>

        <div id="tab-receivers" class="content-card">
            <div class="d-flex justify-content-between mb-4 border-bottom pb-2">
                <h3>收件规则配置</h3>
                <button class="btn btn-sm btn-success" onclick="showRecvModal()">+ 新增规则</button>
            </div>
            <div class="alert alert-info small">
                <i class="fas fa-info-circle"></i> 
                配置完成后，访问链接格式：<code>https://你的域名/查询码</code> 即可收取邮件。
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>名称</th>
                        <th>查询码</th>
                        <th>抓取数/有效期</th>
                        <th>匹配规则</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="recvTableBody"></tbody>
            </table>
        </div>

        <div id="tab-logs" class="content-card"><h3>发送记录</h3><table class="table"><tbody id="logTableBody"></tbody></table></div>
        <div id="tab-settings" class="content-card">
            <h3>系统设置</h3>
            <div class="mb-3"><label>接收邮箱</label><input type="text" id="setting_admin_email" class="form-control"></div>
            <button class="btn btn-primary" onclick="saveSettings()">保存</button>
        </div>

    </div>
</div>

<div class="modal fade" id="recvModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">收件规则编辑</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="recvForm">
                    <input type="hidden" id="recvId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">节点名称</label>
                            <input type="text" class="form-control" id="recvName" placeholder="例如：接收验证码" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">查询码 (URL访问凭证)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="recvCode" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="genRecvCode()">生成</button>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">收取新邮件数量</label>
                            <input type="number" class="form-control" id="recvCount" value="10" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">有效期 (天)</label>
                            <input type="number" class="form-control" id="recvDays" value="3" required>
                            <div class="form-text">从保存时间开始倒计时，归0后该查询码失效</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">匹配发件人 (可选)</label>
                        <input type="text" class="form-control" id="recvSender" placeholder="例如: @google.com, service, 10086 (逗号分隔)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">匹配正文关键字 (可选)</label>
                        <input type="text" class="form-control" id="recvBody" placeholder="例如: 验证码, code, 激活 (逗号分隔)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="submitRecv()">保存配置</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 通用逻辑
    let recvModal;
    window.onload = function() {
        if(sessionStorage.getItem('admin_token')) showAdmin();
        recvModal = new bootstrap.Modal(document.getElementById('recvModal'));
    }
    
    async function api(url, method = 'GET', data = null) {
        const headers = { 'Content-Type': 'application/json', 'Authorization': sessionStorage.getItem('admin_token') };
        const res = await fetch(url, { method, headers, body: data ? JSON.stringify(data) : null });
        if(res.status === 401) { logout(); return null; }
        return res.json();
    }

    // 登录与Tab切换
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        const res = await fetch('/api/login', { method:'POST', body: JSON.stringify({username:u, password:p}) });
        const d = await res.json();
        if(d.success) { sessionStorage.setItem('admin_token', d.token); showAdmin(); } else alert(d.msg);
    };
    function showAdmin() { document.getElementById('login-wrapper').style.display='none'; document.getElementById('admin-container').style.display='flex'; loadGmails(); }
    function logout() { sessionStorage.removeItem('admin_token'); location.reload(); }
    
    function switchTab(tab) {
        document.querySelectorAll('.content-card').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(tab === 'receivers') loadReceivers();
        if(tab === 'gmails') loadGmails();
        if(tab === 'logs') loadLogs();
        if(tab === 'settings') loadSettings();
    }

    // --- 收件设置逻辑 (新增核心) ---
    async function loadReceivers() {
        const tbody = document.getElementById('recvTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">加载中...</td></tr>';
        const list = await api('/api/admin/receivers');
        if(!list) return;
        tbody.innerHTML = list.map(item => {
            // 计算剩余天数
            const start = new Date(item.updated_at).getTime();
            const expire = start + (item.valid_days * 86400000);
            const daysLeft = ((expire - Date.now()) / 86400000).toFixed(1);
            const isExpired = daysLeft <= 0;
            
            return `
            <tr class="${isExpired ? 'table-secondary text-muted' : ''}">
                <td>${item.name}</td>
                <td>
                    <code class="user-select-all">${item.access_code}</code>
                    <a href="/${item.access_code}" target="_blank" class="ms-2 btn btn-xs btn-outline-primary"><i class="fas fa-external-link-alt"></i></a>
                </td>
                <td>
                    <div>抓取: ${item.fetch_count}封</div>
                    <div class="small ${isExpired ? 'text-danger' : 'text-success'}">有效期: ${daysLeft}天</div>
                </td>
                <td class="small">
                    <div>发件: ${item.match_sender || '-'}</div>
                    <div>正文: ${item.match_body || '-'}</div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editRecv(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delRecv(${item.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    function showRecvModal() {
        document.getElementById('recvForm').reset();
        document.getElementById('recvId').value = '';
        genRecvCode(); // 默认生成一个
        recvModal.show();
    }

    function editRecv(item) {
        document.getElementById('recvId').value = item.id;
        document.getElementById('recvName').value = item.name;
        document.getElementById('recvCode').value = item.access_code;
        document.getElementById('recvCount').value = item.fetch_count;
        document.getElementById('recvDays').value = item.valid_days;
        document.getElementById('recvSender').value = item.match_sender || '';
        document.getElementById('recvBody').value = item.match_body || '';
        recvModal.show();
    }

    function genRecvCode() {
        // 生成10位大写字母+数字
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 10; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('recvCode').value = result;
    }

    async function submitRecv() {
        const data = {
            id: document.getElementById('recvId').value,
            name: document.getElementById('recvName').value,
            access_code: document.getElementById('recvCode').value,
            fetch_count: parseInt(document.getElementById('recvCount').value),
            valid_days: parseInt(document.getElementById('recvDays').value),
            match_sender: document.getElementById('recvSender').value,
            match_body: document.getElementById('recvBody').value
        };
        const res = await api('/api/admin/receivers', 'POST', data);
        if(res.success) { recvModal.hide(); loadReceivers(); } else alert('保存失败');
    }

    async function delRecv(id) {
        if(confirm('确认删除此规则？')) {
            await api(`/api/admin/receivers/${id}`, 'DELETE');
            loadReceivers();
        }
    }

    // --- 其他原有逻辑 (API节点/日志/设置) ---
    async function loadGmails() {
        const list = await api('/api/admin/gmails');
        const tbody = document.getElementById('gmailTableBody');
        if(list) tbody.innerHTML = list.map(i => `<tr><td>${i.name}</td><td>${i.is_active?'✅':'❌'}</td></tr>`).join('');
    }
    // ... 其他函数 (loadLogs, saveSettings) 请按需补全或保留原样 ...
    async function loadLogs() { /* ... */ }
    async function saveSettings() {
        const email = document.getElementById('setting_admin_email').value;
        await api('/api/admin/config', 'POST', { admin_email: email });
        alert('保存成功');
    }
    async function loadSettings() {
        const cfg = await api('/api/admin/config');
        if(cfg) document.getElementById('setting_admin_email').value = cfg.admin_email || '';
    }
</script>
</body>
</html>
