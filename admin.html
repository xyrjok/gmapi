<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 240px; --primary-color: #409EFF; --sidebar-bg: #2c3e50; }
        body { background-color: #f4f7f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* 登录页 */
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f5f5f5; display: flex; align-items: center; justify-content: center; z-index: 2000; }
        .login-container { width: 380px; padding: 40px; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        
        /* 后台布局 */
        #admin-container { display: none; min-height: 100vh; display: flex; }
        .admin-sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); color: #ecf0f1; position: fixed; top: 0; bottom: 0; left: 0; padding-top: 20px; z-index: 1000; }
        .sidebar-header { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 30px; }
        .nav-link { color: #bdc3c7; padding: 15px 20px; cursor: pointer; display: block; text-decoration: none; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { background: #34495e; color: #fff; border-left-color: var(--primary-color); }
        .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        
        .admin-content { margin-left: var(--sidebar-width); flex: 1; padding: 20px; width: 100%; }
        .content-card { background: #fff; padding: 25px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: none; animation: fadeIn 0.3s; }
        .content-card.active { display: block; }
        @keyframes fadeIn { from { opacity: 0.5; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 移动端适配 */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #fff; border-bottom: 1px solid #eee; z-index: 1001; align-items: center; padding: 0 15px; justify-content: space-between; }
        @media (max-width: 768px) { 
            .mobile-header { display: flex; } 
            .admin-sidebar { transform: translateX(-100%); transition: 0.3s; } 
            .admin-sidebar.show { transform: translateX(0); } 
            .admin-content { margin-left: 0; padding-top: 60px; } 
            #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; }
            #overlay.show { display: block; }
        }
    </style>
</head>
<body>

<div id="login-wrapper">
    <div class="login-container">
        <h3 class="mb-4"><i class="fas fa-mail-bulk text-primary"></i> Gmail 控制台</h3>
        <form id="login-form">
            <input type="text" id="login-username" class="form-control mb-3" placeholder="管理员用户名" required>
            <input type="password" id="login-password" class="form-control mb-3" placeholder="管理员密码" required>
            <button type="submit" class="btn btn-primary w-100">登 录</button>
        </form>
    </div>
</div>

<div id="admin-container">
    <div class="mobile-header">
        <span class="fw-bold">Gmail Console</span>
        <button class="btn btn-sm btn-light" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    </div>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div class="admin-sidebar" id="sidebar">
        <div class="sidebar-header"><i class="fab fa-google"></i> Gmail 后台</div>
        <ul class="list-unstyled">
            <li><a class="nav-link active" onclick="switchTab('gmails')"><i class="fas fa-server"></i> API 节点</a></li>
            <li><a class="nav-link" onclick="switchTab('receivers')"><i class="fas fa-inbox"></i> 收件设置</a></li>
            <li><a class="nav-link" onclick="switchTab('logs')"><i class="fas fa-history"></i> 发送记录</a></li>
            <li><a class="nav-link" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 系统设置</a></li>
            <li><a class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出登录</a></li>
        </ul>
    </div>

    <div class="admin-content">
        
        <div id="tab-gmails" class="content-card active">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0">API 节点管理</h3>
                <div>
                    <button class="btn btn-sm btn-success me-1" onclick="showAddModal()"><i class="fas fa-plus"></i> 添加</button>
                    <button class="btn btn-sm btn-primary" onclick="showBatchModal()"><i class="fas fa-file-import"></i> 批量</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light"><tr><th>名称</th><th>Script URL (部分)</th><th>状态</th><th>操作</th></tr></thead>
                    <tbody id="gmailTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-receivers" class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0">收件规则配置</h3>
                <button class="btn btn-sm btn-success" onclick="showRecvModal()"><i class="fas fa-plus"></i> 新增规则</button>
            </div>
            <div class="alert alert-info small border-0 bg-opacity-10 bg-info text-info-emphasis">
                <i class="fas fa-info-circle me-1"></i> 访问链接格式：<code>https://你的域名/查询码</code> 即可直接收取邮件。
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>名称 / 绑定节点</th>
                            <th>查询码</th>
                            <th>抓取数 / 有效期</th>
                            <th>匹配规则</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recvTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-logs" class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0">发送记录</h3>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="loadLogs()"><i class="fas fa-sync"></i> 刷新</button>
                    <button class="btn btn-sm btn-danger" onclick="clearLogs()"><i class="fas fa-trash"></i> 清空</button>
                </div>
            </div>
            <table class="table table-sm table-hover">
                <thead class="table-light"><tr><th>时间</th><th>主题</th><th>状态</th></tr></thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>

        <div id="tab-settings" class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0">系统设置</h3>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label fw-bold">游客留言接收邮箱</label>
                        <input type="email" class="form-control" id="setting_admin_email" placeholder="example@gmail.com">
                        <div class="form-text">网站前台“联系我们”表单的留言将发送到此邮箱。</div>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> 保存设置</button>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">添加 API 节点</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>显示名称</label><input type="text" class="form-control" id="addName"></div><div class="mb-3"><label>Script URL</label><input type="text" class="form-control" id="addUrl"></div><div class="mb-3"><label>Token</label><input type="text" class="form-control" id="addToken" value="123456"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitAdd()">保存</button></div></div></div></div>

<div class="modal fade" id="batchModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">批量导入节点</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control" id="batchContent" rows="8" placeholder="名称,URL,Token (每行一条，支持逗号或竖线分隔)"></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitBatch()">开始导入</button></div></div></div></div>

<div class="modal fade" id="recvModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">编辑收件规则</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
    <form id="recvForm">
        <input type="hidden" id="recvId">
        
        <div class="mb-3">
            <label class="form-label">指定 API 节点 <span class="text-danger">*</span></label>
            <input class="form-control" list="apiOptions" id="recvTargetApi" placeholder="必填，请输入或选择 API 名称" required>
            <datalist id="apiOptions"></datalist>
            <div class="form-text small">必须指定一个现有的 API 节点名称。</div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">规则名称 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="recvName" placeholder="如: 接收验证码" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">查询码 <span class="text-danger">*</span></label>
                <div class="input-group">
                    <input type="text" class="form-control" id="recvCode" placeholder="URL 访问凭证" required>
                    <button type="button" class="btn btn-outline-secondary" onclick="genRecvCode()">生成</button>
                </div>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">单次抓取数量</label>
                <input type="number" class="form-control" id="recvCount" placeholder="留空默认: 5">
            </div>
            <div class="col-md-6">
                <label class="form-label">有效期 (天)</label>
                <input type="number" class="form-control" id="recvDays" placeholder="留空则永久有效">
            </div>
        </div>
        
        <hr>
        
        <div class="mb-3">
            <label class="form-label">发件人匹配 (可选)</label>
            <input type="text" class="form-control" id="recvSender" placeholder="留空则收取所有发件人">
        </div>
        <div class="mb-3">
            <label class="form-label">正文关键字匹配 (可选)</label>
            <input type="text" class="form-control" id="recvBody" placeholder="留空则收取所有内容">
        </div>
    </form>
</div><div class="modal-footer"><button class="btn btn-primary" onclick="submitRecv()">保存配置</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 全局变量
    let addModal, batchModal, recvModal;

    window.onload = function() {
        // 初始化 Modals
        addModal = new bootstrap.Modal(document.getElementById('addModal'));
        batchModal = new bootstrap.Modal(document.getElementById('batchModal'));
        recvModal = new bootstrap.Modal(document.getElementById('recvModal'));

        // 检查登录状态
        if (sessionStorage.getItem('admin_token')) {
            showAdmin();
        }
    }

    // 通用 API 请求函数
    async function api(url, method = 'GET', data = null) {
        const headers = { 
            'Content-Type': 'application/json', 
            'Authorization': sessionStorage.getItem('admin_token') 
        };
        const opts = { method, headers };
        if (data) opts.body = JSON.stringify(data);
        
        try {
            const res = await fetch(url, opts);
            if (res.status === 401) { logout(); return null; }
            return res.json();
        } catch(e) { console.error(e); return null; }
    }

    // 登录逻辑
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const u = document.getElementById('login-username').value;
        const p = document.getElementById('login-password').value;
        const res = await fetch('/api/login', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: u, password: p}) 
        });
        const d = await res.json();
        if (d.success) { 
            sessionStorage.setItem('admin_token', d.token); 
            showAdmin(); 
        } else { 
            alert(d.msg); 
        }
    };

    function showAdmin() { 
        document.getElementById('login-wrapper').style.display = 'none'; 
        document.getElementById('admin-container').style.display = 'flex'; 
        loadGmails(); 
    }
    function logout() { sessionStorage.removeItem('admin_token'); location.reload(); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('overlay').classList.toggle('show'); }

    // Tab 切换
    function switchTab(name) {
        document.querySelectorAll('.content-card').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if (name === 'gmails') loadGmails();
        if (name === 'receivers') loadReceivers(); // 加载收件规则
        if (name === 'logs') loadLogs();
        if (name === 'settings') loadSettings();
        
        // 移动端自动收起菜单
        if(window.innerWidth <= 768) toggleSidebar();
    }

    // --- 1. Gmail API 节点逻辑 ---
    async function loadGmails() {
        const tbody = document.getElementById('gmailTableBody');
        const list = await api('/api/admin/gmails');
        if (!list) return;
        tbody.innerHTML = list.map(item => `
            <tr>
                <td class="fw-bold">${item.name}</td>
                <td class="small text-muted text-truncate" style="max-width: 150px;">${item.script_url}</td>
                <td><div class="form-check form-switch"><input class="form-check-input" type="checkbox" ${item.is_active ? 'checked' : ''} onchange="toggleActive(${item.id}, this.checked)"></div></td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="delGmail(${item.id})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `).join('');
    }
    function showAddModal() { document.getElementById('addName').value = ''; document.getElementById('addUrl').value = ''; addModal.show(); }
    async function submitAdd() {
        await api('/api/admin/gmails', 'POST', {
            name: document.getElementById('addName').value,
            url: document.getElementById('addUrl').value,
            token: document.getElementById('addToken').value
        });
        addModal.hide(); loadGmails();
    }
    function showBatchModal() { document.getElementById('batchContent').value = ''; batchModal.show(); }
    async function submitBatch() {
        await api('/api/admin/gmails/batch', 'POST', { content: document.getElementById('batchContent').value });
        batchModal.hide(); loadGmails();
    }
    async function delGmail(id) { if(confirm('确认删除?')) { await api(`/api/admin/gmails/${id}`, 'DELETE'); loadGmails(); } }
    async function toggleActive(id, status) { await api('/api/admin/gmails/toggle', 'POST', { id, status: status ? 1 : 0 }); }

    // --- 2. 收件规则逻辑 (修改版) ---
    async function loadReceivers() {
        const tbody = document.getElementById('recvTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">加载中...</td></tr>';
        const list = await api('/api/admin/receivers');
        if (!list) return;
        
        tbody.innerHTML = list.map(item => {
            // 计算有效期
            const isInfinite = item.valid_days === 0;
            let daysDisplay = '';
            
            if (isInfinite) {
                daysDisplay = '<span class="text-success small fw-bold"><i class="fas fa-infinity"></i> 永久有效</span>';
            } else {
                const start = new Date(item.updated_at).getTime();
                const expire = start + (item.valid_days * 86400000);
                const daysLeft = ((expire - Date.now()) / 86400000).toFixed(1);
                const isExpired = daysLeft <= 0;
                daysDisplay = `<span class="small ${isExpired ? 'text-danger fw-bold' : 'text-success'}">剩余: ${daysLeft} 天</span>`;
            }

            return `
            <tr>
                <td>
                    <div class="fw-bold">${item.name}</div>
                    ${item.target_api_name 
                        ? `<span class="badge bg-primary bg-opacity-75 text-white small" style="font-weight:400"><i class="fas fa-server"></i> ${item.target_api_name}</span>` 
                        : '<span class="badge bg-secondary small">随机节点</span>'}
                </td>
                <td>
                    <code class="user-select-all me-2">${item.access_code}</code>
                    <a href="/${item.access_code}" target="_blank" class="btn btn-sm btn-light border" title="打开链接"><i class="fas fa-external-link-alt small"></i></a>
                </td>
                <td>
                    <div class="small">抓取: ${item.fetch_count} 封</div>
                    <div>${daysDisplay}</div>
                </td>
                <td class="small text-muted">
                    <div>发件: ${item.match_sender || '-'}</div>
                    <div>正文: ${item.match_body || '-'}</div>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editRecv(${JSON.stringify(item)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="delRecv(${item.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('');
    }

    // 新增：加载 API 选项
    async function loadApiOptions() {
        const listObj = document.getElementById('apiOptions');
        listObj.innerHTML = '';
        const apis = await api('/api/admin/gmails');
        if (apis) {
            apis.forEach(node => {
                if(node.is_active) {
                    const opt = document.createElement('option');
                    opt.value = node.name;
                    listObj.appendChild(opt);
                }
            });
        }
    }

    async function showRecvModal() {
        document.getElementById('recvForm').reset();
        document.getElementById('recvId').value = '';
        
        // 加载 API 列表
        await loadApiOptions();

        genRecvCode();
        recvModal.show();
    }

    async function editRecv(item) {
        await loadApiOptions();

        document.getElementById('recvId').value = item.id;
        document.getElementById('recvName').value = item.name;
        document.getElementById('recvTargetApi').value = item.target_api_name || ''; // 必填回显
        document.getElementById('recvCode').value = item.access_code;
        
        // 抓取数量：显示数值，留给用户决定是否清空
        document.getElementById('recvCount').value = item.fetch_count; 
        
        // 有效期：如果是 0，显示为空，代表永久
        document.getElementById('recvDays').value = (item.valid_days === 0) ? '' : item.valid_days;
        
        document.getElementById('recvSender').value = item.match_sender || '';
        document.getElementById('recvBody').value = item.match_body || '';
        recvModal.show();
    }

    function genRecvCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 10; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        document.getElementById('recvCode').value = result;
    }

    async function submitRecv() {
        // 1. 校验必填项
        const targetApi = document.getElementById('recvTargetApi').value.trim();
        const name = document.getElementById('recvName').value.trim();
        const code = document.getElementById('recvCode').value.trim();

        if (!targetApi || !name || !code) {
            alert("请完善必填项：API名称、规则名称和查询码不能为空。");
            return;
        }

        // 2. 处理选填项默认值
        const countInput = document.getElementById('recvCount').value.trim();
        const fetchCount = countInput === '' ? 5 : parseInt(countInput); // 留空 -> 5

        const daysInput = document.getElementById('recvDays').value.trim();
        const validDays = daysInput === '' ? 0 : parseInt(daysInput); // 留空 -> 0 (永久)

        const data = {
            id: document.getElementById('recvId').value,
            name: name,
            access_code: code,
            target_api_name: targetApi,
            fetch_count: fetchCount,
            valid_days: validDays,
            match_sender: document.getElementById('recvSender').value.trim(),
            match_body: document.getElementById('recvBody').value.trim()
        };

        const res = await api('/api/admin/receivers', 'POST', data);
        if(res.success) { recvModal.hide(); loadReceivers(); } else alert('保存失败: ' + res.msg);
    }

    async function delRecv(id) {
        if(confirm('确定删除此规则？删除后链接将立即失效。')) {
            await api(`/api/admin/receivers/${id}`, 'DELETE');
            loadReceivers();
        }
    }

    // --- 3. 日志与设置 ---
    async function loadLogs() {
        const tbody = document.getElementById('logTableBody');
        const logs = await api('/api/admin/logs');
        if (!logs) return;
        tbody.innerHTML = logs.map(l => `<tr><td>${new Date(l.created_at).toLocaleString()}</td><td>${l.subject}</td><td>${l.status}</td></tr>`).join('');
    }
    async function clearLogs() { if(confirm('确定清空所有日志?')) { await api('/api/admin/logs/clear', 'POST'); loadLogs(); } }

    async function loadSettings() {
        const config = await api('/api/admin/config');
        if (config && config.admin_email) {
            document.getElementById('setting_admin_email').value = config.admin_email;
        }
    }
    async function saveSettings() {
        const email = document.getElementById('setting_admin_email').value;
        const res = await api('/api/admin/config', 'POST', { admin_email: email });
        if (res.success) alert("设置保存成功");
        else alert("保存失败");
    }
</script>
</body>
</html>
