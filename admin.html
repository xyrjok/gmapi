<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://bk.xyrj.dpdns.org/themes/xyrj/files/fonts/fontawesome5pro-all.min.css" rel="stylesheet">
    <style>
        :root { --sidebar-width: 240px; --header-height: 60px; --primary-color: #409EFF; --sidebar-bg: #2c3e50; --sidebar-hover: #34495e; }
        body { background-color: #f4f7f6; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        
        /* 登录页样式 */
        #login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f5f5f5; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .login-container { width: 90%; max-width: 380px; padding: 40px; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .login-logo { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 25px; display: block; }
        .btn-xyrj { width: 100%; background-color: var(--primary-color); color: #fff; border: none; padding: 10px; border-radius: 4px; transition: 0.3s; }
        .btn-xyrj:hover { background-color: #3390ff; }
        
        /* 后台框架 */
        #admin-container { display: none; min-height: 100vh; display: flex; }
        .admin-sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: #ecf0f1; position: fixed; top: 0; bottom: 0; left: 0; overflow-y: auto; z-index: 1000; }
        .sidebar-header { height: var(--header-height); line-height: var(--header-height); text-align: center; font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.1); border-bottom: 1px solid #34495e; }
        .nav-link { color: #bdc3c7; padding: 15px 20px; cursor: pointer; display: block; text-decoration: none; border-left: 4px solid transparent; }
        .nav-link:hover { background: var(--sidebar-hover); color: #fff; }
        .nav-link.active { background: #e74c3c; color: #fff; border-left-color: #c0392b; }
        .nav-link i { margin-right: 10px; width: 24px; text-align: center; }
        .admin-content { margin-left: var(--sidebar-width); flex: 1; padding: 20px; width: 100%; }
        .content-card { background: #fff; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 20px; display: none; }
        .content-card.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0.5; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 移动端适配 */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 50px; background: #fff; border-bottom: 1px solid #eee; z-index: 1001; align-items: center; padding: 0 15px; justify-content: space-between; }
        @media (max-width: 768px) { .mobile-header { display: flex; } .admin-sidebar { transform: translateX(-100%); transition: 0.3s; } .admin-sidebar.show { transform: translateX(0); } .admin-content { margin-left: 0; padding-top: 60px; } #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; } #overlay.show { display: block; } }
    </style>
</head>
<body>

<div id="login-wrapper">
    <div class="login-container">
        <div class="login-logo"><i class="fad fa-mail-bulk text-primary"></i> Gmail 控制台</div>
        <form id="login-form">
            <input type="text" id="login-username" class="form-control mb-3" placeholder="管理员用户名" required>
            <input type="password" id="login-password" class="form-control mb-3" placeholder="管理员密码" required>
            <button type="submit" class="btn-xyrj">登 录</button>
        </form>
    </div>
</div>

<div id="admin-container">
    <div class="mobile-header">
        <span class="fw-bold">Gmail Console</span>
        <button class="btn btn-sm btn-light" onclick="toggleSidebar()"><i class="far fa-bars"></i></button>
    </div>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div class="admin-sidebar" id="sidebar">
        <div class="sidebar-header"><i class="fab fa-google"></i> Gmail 后台</div>
        <ul style="padding:0; list-style:none;">
            <li><a class="nav-link active" onclick="switchTab('gmails')"><i class="fas fa-server"></i> API 节点管理</a></li>
            <li><a class="nav-link" onclick="switchTab('logs')"><i class="fas fa-history"></i> 发送记录</a></li>
            <li><a class="nav-link" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 系统设置</a></li>
            <li><a class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出</a></li>
        </ul>
    </div>

    <div class="admin-content">
        <div id="tab-gmails" class="content-card active">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0"><i class="fas fa-network-wired"></i> API 节点配置</h3>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="showAddModal()"><i class="fas fa-plus"></i> 添加</button>
                    <button class="btn btn-sm btn-primary me-2" onclick="showBatchModal()"><i class="fas fa-layer-group"></i> 批量导入</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>显示名称</th>
                            <th>Script URL (部分)</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="gmailTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-logs" class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0"><i class="fas fa-list-ul"></i> 发送记录</h3>
                <div>
                    <button class="btn btn-sm btn-danger me-2" onclick="clearLogs()"><i class="fas fa-trash-alt"></i> 清空</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()"><i class="fas fa-sync-alt"></i> 刷新</button>
                </div>
            </div>
            <table class="table table-hover align-middle">
                <thead class="table-light"><tr><th>ID</th><th>时间</th><th>主题</th><th>状态</th></tr></thead>
                <tbody id="logTableBody"></tbody>
            </table>
        </div>

        <div id="tab-settings" class="content-card">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                <h3 class="m-0"><i class="fas fa-cog"></i> 系统设置</h3>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">游客留言接收邮箱</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                <input type="email" class="form-control" id="setting_admin_email" placeholder="example@gmail.com" required>
                            </div>
                            <div class="form-text text-muted">前台游客提交的留言将发送到此邮箱。</div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> 保存设置</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">添加 API 节点</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label>显示名称</label><input type="text" class="form-control" id="addName"></div><div class="mb-3"><label>Script URL</label><input type="text" class="form-control" id="addUrl"></div><div class="mb-3"><label>Token</label><input type="text" class="form-control" id="addToken" value="123456"></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitAdd()">保存</button></div></div></div></div>
<div class="modal fade" id="batchModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">批量导入</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><textarea class="form-control" id="batchContent" rows="10" placeholder="名称,URL,Token (每行一条)"></textarea></div><div class="modal-footer"><button class="btn btn-primary" onclick="submitBatch()">导入</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const loginWrapper = document.getElementById('login-wrapper');
    const adminContainer = document.getElementById('admin-container');
    let addModal, batchModal;

    window.onload = function() {
        addModal = new bootstrap.Modal(document.getElementById('addModal'));
        batchModal = new bootstrap.Modal(document.getElementById('batchModal'));
        if (sessionStorage.getItem('admin_token')) showAdmin();
    }

    async function api(url, method = 'GET', data = null) {
        const headers = { 'Content-Type': 'application/json', 'Authorization': sessionStorage.getItem('admin_token') };
        const opts = { method, headers };
        if (data) opts.body = JSON.stringify(data);
        const res = await fetch(url, opts);
        if (res.status === 401) { logout(); return null; }
        return res.json();
    }

    function showAdmin() { 
        loginWrapper.style.display = 'none'; 
        adminContainer.style.display = 'flex'; 
        loadGmails(); 
    }
    function logout() { sessionStorage.removeItem('admin_token'); location.reload(); }

    // 登录逻辑 (修改：发送用户名和密码)
    document.getElementById('login-form').onsubmit = async (e) => {
        e.preventDefault();
        const user = document.getElementById('login-username').value;
        const pass = document.getElementById('login-password').value;
        try {
            const res = await fetch('/api/login', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: user, password: pass }) 
            });
            const data = await res.json();
            if (data.success) { 
                sessionStorage.setItem('admin_token', data.token); 
                showAdmin(); 
            } else { alert(data.msg); }
        } catch (err) { alert('网络错误'); }
    };

    function switchTab(name) {
        document.querySelectorAll('.content-card').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if (name === 'gmails') loadGmails();
        if (name === 'logs') loadLogs();
        if (name === 'settings') loadSettings(); // 加载设置
        
        if(window.innerWidth <= 768) toggleSidebar();
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('overlay').classList.toggle('show'); }

    // --- Gmail API 管理 ---
    async function loadGmails() {
        const tbody = document.getElementById('gmailTableBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">加载中...</td></tr>';
        const list = await api('/api/admin/gmails');
        if (!list) return;
        tbody.innerHTML = list.map(item => `
            <tr>
                <td>${item.id}</td>
                <td class="fw-bold text-primary">${item.name}</td>
                <td class="small text-muted text-truncate" style="max-width: 200px;">${item.script_url}</td>
                <td><div class="form-check form-switch"><input class="form-check-input" type="checkbox" ${item.is_active ? 'checked' : ''} onchange="toggleActive(${item.id}, this.checked)"></div></td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="delGmail(${item.id})"><i class="fas fa-trash"></i></button></td>
            </tr>
        `).join('');
    }
    function showAddModal() { document.getElementById('addName').value = ''; document.getElementById('addUrl').value = ''; addModal.show(); }
    async function submitAdd() {
        const res = await api('/api/admin/gmails', 'POST', {
            name: document.getElementById('addName').value,
            url: document.getElementById('addUrl').value,
            token: document.getElementById('addToken').value
        });
        if (res.success) { addModal.hide(); loadGmails(); }
    }
    function showBatchModal() { document.getElementById('batchContent').value = ''; batchModal.show(); }
    async function submitBatch() {
        const res = await api('/api/admin/gmails/batch', 'POST', { content: document.getElementById('batchContent').value });
        if (res.success) { batchModal.hide(); loadGmails(); }
    }
    async function delGmail(id) { if(confirm('确认删除?')) { await api(`/api/admin/gmails/${id}`, 'DELETE'); loadGmails(); } }
    async function toggleActive(id, status) { await api('/api/admin/gmails/toggle', 'POST', { id, status: status ? 1 : 0 }); }

    // --- 日志逻辑 ---
    async function loadLogs() {
        const tbody = document.getElementById('logTableBody');
        const logs = await api('/api/admin/logs');
        if (!logs) return;
        tbody.innerHTML = logs.map(l => `<tr><td>${l.id}</td><td>${new Date(l.created_at).toLocaleString()}</td><td>${l.subject}</td><td>${l.status}</td></tr>`).join('');
    }
    async function clearLogs() { if(confirm('确定清空?')) { await api('/api/admin/logs/clear', 'POST'); loadLogs(); } }

    // --- 系统设置逻辑 (新增) ---
    async function loadSettings() {
        const config = await api('/api/admin/config');
        if (config && config.admin_email) {
            document.getElementById('setting_admin_email').value = config.admin_email;
        }
    }
    
    document.getElementById('settingsForm').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('setting_admin_email').value;
        const res = await api('/api/admin/config', 'POST', { admin_email: email });
        if (res.success) alert("保存成功！");
        else alert("保存失败");
    };
</script>
</body>
</html>
